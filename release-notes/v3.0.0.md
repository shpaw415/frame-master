# v3.0.0

## Plugin Chaining

A powerful new feature that allows multiple plugins to transform the same file sequentially. When multiple plugins register `onLoad` handlers for the same file pattern, their outputs are chained together—the output of one becomes the input of the next.

### Overview

Without chaining, if two plugins both handle `.tsx` files, only the first one would run (Bun's default behavior). With chaining enabled, both plugins process the file in sequence, allowing for composable transformations.

```
Original File ──► Plugin A ──► Plugin B ──► Final Output
```

### Configuration

Plugin chaining is **enabled by default**. You can disable it in your `frame-master.config.ts`:

```typescript
export default {
  pluginsOptions: {
    disableOnLoadChaining: true, // Disable chaining
  },
} satisfies FrameMasterConfig;
```

### Chained Arguments

Plugins access content and loader from previous handlers via special properties:

- **`args.__chainedContents`** - The transformed content from previous handlers
- **`args.__chainedLoader`** - The loader type returned by the previous handler

```typescript
build.onLoad({ filter: /\.tsx$/ }, async (args) => {
  const content = args.__chainedContents ?? (await Bun.file(args.path).text());
  const previousLoader = args.__chainedLoader; // e.g., "tsx", "js", etc. (or undefined if it is the first)

  return {
    contents: `import "my-lib";\n${content}`,
    loader: "tsx",
  };
});
```

### Helper Function

```typescript
import { getChainableContent } from "frame-master/plugin";

const content = await getChainableContent(args);
```

### New Exports

| Export                      | Description                                    |
| --------------------------- | ---------------------------------------------- |
| `chainPlugins(plugins)`     | Chain multiple BunPlugins into a single plugin |
| `getChainableContent(args)` | Helper to get content from chain or disk       |
| `PluginProxy`               | Low-level class for manual plugin chaining     |

See the [Plugin Chaining documentation](../docs/plugin-chaining.md) for complete details.

---

## Hot Reload Configuration

Frame-Master now supports **hot-reloading** of the `frame-master.config.ts` file during development. When you modify the config file, the server automatically:

1. Reloads configuration from disk
2. Reinitializes all plugins with new settings
3. Rebuilds the builder with updated build configs
4. Recreates file system watchers for new plugin directories
5. Reloads the HTTP server with new routes and settings

### Limitation

- Hot reloading Runtime plugin is not working in hot mode. **You must cold restart the server**

### Usage

Hot reload is automatic in development mode. Simply edit your `frame-master.config.ts` and save.

### New Plugin Hook: `onConfigReload`

Plugins can now react to configuration changes:

```typescript
export function myPlugin(): FrameMasterPlugin {
  return {
    name: "my-plugin",
    version: "1.0.0",
    onConfigReload: async () => {
      console.log("Config reloaded, reinitializing...");
      await reinitializePluginState();
    },
  };
}
```

## HotFileWatcher Utility

A new public utility for plugin developers to watch individual files for changes.

### Import

```typescript
import {
  HotFileWatcher,
  createHotFileWatcher,
} from "frame-master/server/hot-file-watcher";
```

### Usage

```typescript
const watcher = new HotFileWatcher({
  filePath: "my-plugin.config.json",
  onReload: async (path) => {
    console.log("Config changed:", path);
    await reloadMyPluginConfig();
  },
  debounceDelay: 200,
  name: "MyPluginConfig",
  verbose: true,
});

await watcher.start();

// Later, to stop:
watcher.stop();
```

### API

| Method            | Description                          |
| ----------------- | ------------------------------------ |
| `start()`         | Start watching the file              |
| `stop()`          | Stop watching                        |
| `triggerReload()` | Manually trigger the reload callback |
| `isActive()`      | Check if currently watching          |
| `getPath()`       | Get the absolute path being watched  |

## Helper Functions

New utility functions for plugin developers available from `frame-master/utils`:

### `isVerbose()`

Check if verbose mode is enabled (`FRAME_MASTER_VERBOSE=true`).

```typescript
import { isVerbose } from "frame-master/utils";

if (isVerbose()) {
  console.log("[MyPlugin] Debug info:", data);
}
```

### `verboseLog(...args)`

Log only when verbose mode is enabled.

```typescript
import { verboseLog } from "frame-master/utils";

verboseLog("[MyPlugin] Processing:", filePath);
```

### `isBuildMode()`

Check if Frame-Master is in build/initialization phase (before server starts).

```typescript
import { isBuildMode } from "frame-master/utils";

if (isBuildMode()) {
  // Build-time only logic
}
```

### `isServerRunning()`

Check if the server is running.

```typescript
import { isServerRunning } from "frame-master/utils";

if (isServerRunning()) {
  // Runtime logic
}
```

### `isDev()` / `isProd()`

Check the current environment mode.

```typescript
import { isDev, isProd } from "frame-master/utils";

if (isDev()) {
  // Development-only features
}

if (isProd()) {
  // Production optimizations
}
```

## Server Reload API

New functions for programmatic server control:

### `reloadServer()`

Stops the existing server and creates a new one with updated configuration.

```typescript
import { reloadServer } from "frame-master/server";

reloadServer();
```

### `reinitAll()`

Full reinitialization of all core components (config, plugins, builder, watchers).

```typescript
import { reinitAll } from "frame-master/server/init";

await reinitAll();
```

## New Exports

| Export Path                            | Description                             |
| -------------------------------------- | --------------------------------------- |
| `frame-master/server/config-watcher`   | Config hot-reload utilities             |
| `frame-master/server/hot-file-watcher` | Generic file watcher for plugins        |
| `frame-master/server/init`             | Server initialization and `reinitAll()` |

## Breaking Changes

### Build Command No Longer Triggers `serverStart` Hooks

The `frame-master build` command now uses modular initialization and **no longer runs `serverStart` hooks** (`main()` and `dev_main()`).

**Migration:** If your plugin relies on `serverStart` for pre-build initialization, migrate that logic to the `createContext` hook instead:

```typescript
// Before (v2.x) - no longer works for build command
export function myPlugin(): FrameMasterPlugin {
  return {
    name: "my-plugin",
    version: "1.0.0",
    serverStart: {
      main: async () => {
        await initializeForBuild();
      },
    },
  };
}

// After (v3.x) - use createContext for build-time initialization
export function myPlugin(): FrameMasterPlugin {
  return {
    name: "my-plugin",
    version: "1.0.0",
    createContext: async (config) => {
      await initializeForBuild();
    },
    serverStart: {
      main: async () => {
        // Server-only initialization (not called during build)
      },
    },
  };
}
```

## Bug Fixes

- Fixed TypeScript type errors for WebSocket handlers with `ServerWebSocket<unknown>`
